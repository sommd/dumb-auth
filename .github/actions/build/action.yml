name: Build
description: Build dumb-auth binary
inputs:
  version:
    description: Version to set in Cargo.toml before building
    required: true
  profile:
    description: Cargo profile to use
    default: release
  target:
    description: Target architecture to build
    required: true
  test:
    description: Run tests after building
    default: "true"
runs:
  using: composite
  steps:
    - name: Set version
      shell: bash
      run: sed -i 's/^version = "[^"]*"/version = "${{ inputs.version }}"/' Cargo.toml
    - name: Install target
      shell: bash
      run: rustup target add '${{ inputs.target }}'
    - name: Install musl-gcc
      if: endsWith(inputs.target, '-musl')
      shell: bash
      run: sudo apt-get update && sudo apt-get install -y musl-tools
    - name: Build
      shell: bash
      run: cargo build --profile '${{ inputs.profile }}' --target '${{ inputs.target }}'
    - name: Test
      if: ${{ inputs.test == 'true' }}
      shell: bash
      run: cargo test --profile '${{ inputs.profile }}' --target '${{ inputs.target }}'
    - name: Rename binary
      shell: bash
      run: mv 'target/${{ inputs.target }}/${{ inputs.profile }}/dumb-auth' 'dumb-auth-${{ inputs.target }}'
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: dumb-auth-${{ inputs.target }}
        path: dumb-auth-${{ inputs.target }}
        if-no-files-found: error
